name: Build and Scan Docker Image

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Job que hereda el workflow reusable para escaneo con Trivy
  scan-with-trivy:
    uses: ./.github/workflows/reusable-docker-scan.yml
    with:
      image-name: 'myapp'
      image-tag: ${{ github.sha }}
      severity: 'HIGH'
      scanner: 'trivy'
    secrets: inherit

  # Job que hereda el workflow reusable para escaneo con Snyk
  scan-with-snyk:
    uses: ./.github/workflows/reusable-docker-scan.yml
    with:
      image-name: 'myapp'
      image-tag: ${{ github.sha }}
      severity: 'high'
      scanner: 'snyk'
    secrets:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  # Job que procesa los resultados
  process-results:
    needs: [scan-with-trivy, scan-with-snyk]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check scan results
        run: |
          echo "Trivy scan result: ${{ needs.scan-with-trivy.outputs.scan-result }}"
          echo "Trivy vulnerabilities: ${{ needs.scan-with-trivy.outputs.vulnerabilities-found }}"
          echo "Snyk scan result: ${{ needs.scan-with-snyk.outputs.scan-result }}"
          echo "Snyk vulnerabilities: ${{ needs.scan-with-snyk.outputs.vulnerabilities-found }}"
          
      - name: Notify on failure
        if: needs.scan-with-trivy.result == 'failure' || needs.scan-with-snyk.result == 'failure'
        run: |
          echo "ðŸš¨ Security scan failed! Please review the vulnerabilities."
          exit 1
